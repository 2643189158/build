name: GetSukiSUManager

permissions:
  contents: write
  actions: read

on:
  workflow_call:
    inputs:
      kernelsu_variant:
        required: true
        type: string

jobs:
  get_sukisu_manager:
    runs-on: ubuntu-latest
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: 安装依赖
        run: sudo apt update && sudo apt upgrade -y && sudo apt install -y git curl jq

      - name: 设定 SukiSU 环境变量
        run: |
          if [ "${{ inputs.kernelsu_variant }}" == "SukiSU" ]; then
            echo "This is the SukiSU variant"
            git clone https://github.com/SukiSU-Ultra/SukiSU-Ultra.git
            cd SukiSU-Ultra
            KSU_GIT_VERSION=$(git rev-list --count HEAD)
            KSU_VERSION=$((10000 + KSU_GIT_VERSION + 606))
            echo $KSU_VERSION
            echo "KSU_VERSION=$KSU_VERSION" >> $GITHUB_ENV
          else
            echo "Only SukiSU is supported in this workflow"
          fi

      - name: 设定 SukiSU 环境变量
        run: |
         if [ "${{ inputs.kernelsu_variant }}" == "SukiSU" ]; then
         echo "This is the SukiSU variant"
         git clone https://github.com/SukiSU-Ultra/SukiSU-Ultra.git
         cd SukiSU-Ultra
         KSU_GIT_VERSION=$(git rev-list --count HEAD)
         KSU_VERSION=$((10000 + KSU_GIT_VERSION + 606))
         echo "计算后的 KSU_VERSION: $KSU_VERSION"
         echo "KSU_VERSION=$KSU_VERSION" >> $GITHUB_ENV  # 确保注入到全局环境变量
         else
         echo "Only SukiSU is supported in this workflow"
         exit 1  # 明确退出以避免后续步骤执行
         fi

      - name: 上传编译资产
        uses: actions/upload-artifact@v4
        with:
          name: SukiSU-Manager(${{ env.KSU_VERSION }})
          path: |
            *.apk
